# Graceful Failure Handling in Hypequery CLI

The CLI now handles all failure and cancellation scenarios gracefully, allowing users to complete setup even without database credentials.

## Scenarios Handled

### 1. User Cancels Database Type Selection (Ctrl+C / ESC)
**Behavior:** CLI exits cleanly with "Setup cancelled" message
```
? Which database are you using? [cancelled]
  Setup cancelled
```

### 2. User Skips Connection Details
**User Action:** Presses ESC or Ctrl+C when prompted for connection details

**Behavior:**
- CLI continues with setup
- Creates placeholder `.env` file with clear instructions
- Creates placeholder `schema.ts`
- Creates working `client.ts` and `queries.ts`
- Shows next steps for configuration

**Output:**
```
  Skipping database connection for now.

  ✓  Created .env (configure your credentials)
  ✓  Created placeholder schema (analytics/schema.ts)
  ✓  Created ClickHouse client (analytics/client.ts)
  ✓  Created queries file (analytics/queries.ts)

  Setup complete!

  Next steps:

    1. Configure your database connection in .env
    2. Run: npx hypequery generate    (to generate types)
    3. Run: npx hypequery dev          (to start dev server)

  Docs: https://hypequery.com/docs
```

**Files Created:**
- `.env` with placeholders:
  ```bash
  # Hypequery Configuration
  # Replace these placeholder values with your actual ClickHouse credentials

  CLICKHOUSE_HOST=YOUR_CLICKHOUSE_HOST
  CLICKHOUSE_DATABASE=YOUR_DATABASE
  CLICKHOUSE_USERNAME=YOUR_USERNAME
  CLICKHOUSE_PASSWORD=YOUR_PASSWORD
  ```

- `analytics/schema.ts` with placeholder:
  ```typescript
  // Generated by @hypequery/clickhouse
  // Run 'npx hypequery generate' after configuring your database connection

  export interface IntrospectedSchema {
    // Your table types will appear here after generation
  }
  ```

### 3. Connection Test Fails
**User Action:** Provides credentials but connection fails

**Behavior:**
- Shows helpful error message with common issues
- Asks: "Try again?"
  - If **Yes** → Restarts from connection prompts
  - If **No** → Asks "Continue setup without database connection?"
    - If **Yes** → Proceeds as in scenario #2
    - If **No** → Exits cleanly

**Output:**
```
  ✗  Connection failed

  Could not connect to ClickHouse at http://localhost:8123

  Common issues:
    • Check your host URL includes http:// or https://
    • Verify username and password
    • Ensure database exists
    • Check firewall/network access

? Try again? No
? Continue setup without database connection? Yes

  Continuing without database connection.
  You can configure the connection later in .env

  ✓  Created .env (configure your credentials)
  ...
```

### 4. User Cancels During File Path Selection
**Behavior:** Uses default path `analytics/`

### 5. User Cancels During Example Query Selection
**Behavior:** Continues without example query, creates basic template

## Key Design Decisions

### No Forced Exits
- Prompts library configured with `onCancel: () => {}` to prevent auto-exit
- All prompt functions return `null` on cancellation
- Init command checks for `null` and handles gracefully

### Placeholder Files
When DB connection is unavailable:
- `.env` contains clear placeholder values with `YOUR_*` prefix
- `schema.ts` contains helpful comment and empty interface
- Other files are fully functional and work offline

### Clear Next Steps
Success messages adapt based on whether connection succeeded:
- **With connection:** "Try your first query" + dev server command
- **Without connection:** Step-by-step instructions to complete setup

### Recovery Path
Users can always:
1. Update `.env` with real credentials
2. Run `npx hypequery generate` to create types
3. Run `npx hypequery dev` to start server

## Testing Scenarios

### Test 1: Full Skip
```bash
npx hypequery init
# Press ESC on connection prompt
# Verify all files created
# Verify .env has placeholders
# Verify schema.ts has placeholder comment
```

### Test 2: Failed Connection → Continue
```bash
npx hypequery init
# Enter invalid credentials
# Choose "No" on retry
# Choose "Yes" on continue
# Verify same result as Test 1
```

### Test 3: Failed Connection → Retry → Skip
```bash
npx hypequery init
# Enter invalid credentials
# Choose "Yes" on retry
# Press ESC on retry prompt
# Verify graceful continuation
```

### Test 4: Successful Connection
```bash
npx hypequery init
# Enter valid credentials
# Verify connection success
# Verify real schema generated
# Verify .env has real values (no placeholders)
```

## User Experience Principles

✅ **Never block progress** - Users can always complete setup
✅ **Clear feedback** - Every action has clear output
✅ **Helpful errors** - Error messages suggest fixes
✅ **Flexible recovery** - Users can fix issues later
✅ **No data loss** - Cancellation never loses work
✅ **Calm output** - No panicked error messages

## Future Enhancements

- [ ] Add `hypequery configure` command to update existing setup
- [ ] Validate `.env` file and suggest fixes
- [ ] Interactive `.env` editor
- [ ] Connection health check command
