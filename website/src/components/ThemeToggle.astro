---
const options = [
  { label: "Light", value: "light" },
  { label: "Dark", value: "dark" },
  { label: "System", value: "system" },
];
---

<div class="relative" data-theme-toggle>
  <button type="button" class="theme-button" aria-label="Toggle theme" data-theme-button>
    <span class="sr-only">Toggle theme</span>
    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <circle cx="12" cy="12" r="4"></circle>
      <path d="M12 3v2M12 19v2M5.64 5.64l1.42 1.42M16.94 16.94l1.42 1.42M3 12h2M19 12h2M5.64 18.36l1.42-1.42M16.94 7.06l1.42-1.42" />
    </svg>
    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" />
    </svg>
    <svg class="icon-system" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="4" width="18" height="14" rx="2" />
      <path d="M8 20h8" />
    </svg>
  </button>
  <div class="theme-select-wrapper" data-theme-wrapper>
    <div class="theme-options" role="menu">
      {options.map((option) => (
        <button
          type="button"
          class="theme-option"
          data-theme-option={option.value}
          aria-pressed="false"
        >
          <span>{option.label}</span>
        </button>
      ))}
    </div>
  </div>
</div>

<script>
  const initThemeToggle = () => {
    const container = document.querySelector('[data-theme-toggle]');
    if (!container) return;

    const button = container.querySelector('[data-theme-button]');
    const wrapper = container.querySelector('[data-theme-wrapper]');
    const optionButtons = wrapper?.querySelectorAll('[data-theme-option]');
    if (!button || !wrapper || !optionButtons?.length) return;

    const get = window.__hypequeryGetTheme || (() => 'system');
    const set = window.__hypequerySetTheme || (() => {});

    const update = () => {
      const mode = get ? get() : 'system';
      container.dataset.mode = mode || 'system';
      optionButtons.forEach((btn) => {
        const option = btn.getAttribute('data-theme-option');
        const isActive = option === mode;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    };

    update();

    optionButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const value = btn.getAttribute('data-theme-option');
        if (!value) return;
        set(value);
        wrapper.classList.remove('open');
      });
    });

    button.addEventListener('click', (event) => {
      event.stopPropagation();
      wrapper.classList.toggle('open');
    });

    document.addEventListener('click', (event) => {
      if (!container.contains(event.target as Node)) {
        wrapper.classList.remove('open');
      }
    });

    window.addEventListener('hypequery-theme-change', update);
  };

  if (document.readyState !== 'loading') {
    initThemeToggle();
  } else {
    document.addEventListener('DOMContentLoaded', initThemeToggle);
  }
</script>
