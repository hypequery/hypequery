---
layout: ../../../layouts/DocsLayout.astro
title: Advanced Functions - HypeQuery
description: Learn about advanced query features like CTEs and time-based functions
---

# Advanced Functions

HypeQuery provides several advanced features for complex queries and analytics. This guide covers Common Table Expressions (CTEs) and time-based functions.

## Common Table Expressions (CTEs)

CTEs allow you to create temporary named result sets that you can reference within your query:

```typescript
const subquery = db
  .table('orders')
  .select(['user_id'])
  .sum('amount', 'total_spent')
  .groupBy('user_id');

const results = await db
  .table('users')
  .withCTE('user_totals', subquery)
  .select(['users.name', 'user_totals.total_spent'])
  .execute();
```

You can also use raw SQL for CTEs:

```typescript
const results = await db
  .table('users')
  .withCTE(
    'active_users',
    'SELECT user_id FROM sessions WHERE last_active > NOW() - INTERVAL 1 DAY'
  )
  .execute();
```

## Time-Based Functions

### Time Intervals

Group data by various time intervals:

```typescript
const results = await db
  .table('events')
  .select(['date'])
  .sum('value')
  .groupByTimeInterval('date', '1 hour')
  .execute();
```

### Predefined Time Functions

Use built-in time functions:

```typescript
// Group by minute
db.groupByTimeInterval('timestamp', null, 'toStartOfMinute')

// Group by hour
db.groupByTimeInterval('timestamp', null, 'toStartOfHour')

// Group by day
db.groupByTimeInterval('timestamp', null, 'toStartOfDay')

// Group by week
db.groupByTimeInterval('timestamp', null, 'toStartOfWeek')

// Group by month
db.groupByTimeInterval('timestamp', null, 'toStartOfMonth')

// Group by quarter
db.groupByTimeInterval('timestamp', null, 'toStartOfQuarter')

// Group by year
db.groupByTimeInterval('timestamp', null, 'toStartOfYear')
```

### Custom Intervals

Specify custom time intervals:

```typescript
// 5-minute intervals
db.groupByTimeInterval('timestamp', '5 minute')

// 2-hour intervals
db.groupByTimeInterval('timestamp', '2 hour')

// 7-day intervals
db.groupByTimeInterval('timestamp', '7 day')
```

## Query Settings

Customize ClickHouse query settings:

```typescript
const results = await db
  .table('large_table')
  .settings({
    max_execution_time: 60,
    max_threads: 4,
    max_memory_usage: '10000000000'
  })
  .execute();
```

## Combining Advanced Features

Here's an example combining multiple advanced features:

```typescript
const activeUsers = db
  .table('sessions')
  .select(['user_id'])
  .where('last_active', 'gt', 'NOW() - INTERVAL 1 DAY')
  .distinct();

const results = await db
  .table('events')
  .withCTE('active_users', activeUsers)
  .select(['date'])
  .sum('value', 'total_value')
  .groupByTimeInterval('date', '1 hour')
  .settings({ max_execution_time: 30 })
  .execute();
```

## Type Safety

All advanced functions maintain full type safety:

```typescript
interface Schema {
  events: {
    date: 'DateTime';
    value: 'Float64';
  }
}

const db = createQueryBuilder<Schema>();

// TypeScript will catch these errors:
db.groupByTimeInterval('invalid_column', '1 hour'); // Error: invalid column
db.groupByTimeInterval('value', '1 hour'); // Error: value is not a date/time column
```

## Next Steps

- Learn about [Pagination](/docs/guides/pagination) for handling large result sets
- Explore [Helper Methods](/docs/guides/helper-methods) for additional functionality
- Check out the [API Reference](/docs/reference/api) for detailed method documentation 