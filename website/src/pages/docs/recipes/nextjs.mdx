---
layout: ../../../layouts/DocsLayout.astro
title: Next.js Integration
description: Wire hypequery into a Next.js App Router project with type-safe HTTP endpoints and hooks.
---

# Next.js + hypequery

Use hypequery to expose analytics as an HTTP endpoint inside your Next.js application, then consume them with generated React hooks.

## Use case

You are building an internal dashboard or agent surface inside Next.js and want:

- A server-side analytics catalog (`api.run`) with input/output validation
- A `/api/hypequery/*` route you can deploy on Vercel or any Node runtime
- Auto-generated React Query hooks for client components

## Prerequisites

- Node.js 18+
- Next.js 13/14 App Router project (`app/` directory)
- A ClickHouse connection URL (`CLICKHOUSE_URL`, `CLICKHOUSE_USER`, `CLICKHOUSE_PASSWORD`)
- Packages: `@hypequery/serve`, `@hypequery/clickhouse`, `zod`, `@hypequery/react`, `@tanstack/react-query`

```bash
# Add runtime + client packages
npm install @hypequery/serve @hypequery/clickhouse zod
npm install @hypequery/react @tanstack/react-query
```

## 1. Create a ClickHouse client

`src/analytics/client.ts`

```typescript
import 'dotenv/config';
import { createQueryBuilder } from '@hypequery/clickhouse';
import type { IntrospectedSchema } from './schema';

export const db = createQueryBuilder<IntrospectedSchema>({
  url: process.env.CLICKHOUSE_URL!,
  username: process.env.CLICKHOUSE_USER!,
  password: process.env.CLICKHOUSE_PASSWORD,
});
```

Run `npx hypequery generate` first so `schema.ts` exists.

## 2. Define hypequery analytics

`src/analytics/queries.ts`

```typescript
import { initServe } from '@hypequery/serve';
import { z } from 'zod';
import { db } from './client';

const { define, queries, query } = initServe({
  context: () => ({ db }),
});

export const api = define({
  queries: queries({
    weeklyRevenue: query
      .describe('Weekly revenue totals')
      .input(z.object({
        startDate: z.string().datetime(),
        endDate: z.string().datetime(),
      }))
      .output(z.array(z.object({ day: z.string(), revenue: z.number() })))
      .query(async ({ ctx, input }) =>
        ctx.db
          .table('orders')
          .where('created_at', 'gte', input.startDate)
          .where('created_at', 'lte', input.endDate)
          .groupBy(['toStartOfWeek(created_at) AS day'])
          .sum('amount', 'revenue')
          .orderBy('day', 'ASC')
          .execute()
      ),

    topProducts: query
      .describe('Top products by revenue')
      .output(z.array(z.object({ name: z.string(), revenue: z.number() })))
      .query(async ({ ctx }) =>
        ctx.db
          .table('orders')
          .groupBy(['product_name AS name'])
          .sum('amount', 'revenue')
          .orderBy('revenue', 'DESC')
          .limit(5)
          .execute()
      ),
  }),
});
```

## 3. Register the HTTP route (App Router)

`app/api/hypequery/[...hq]/route.ts`

```typescript
import { api } from '@/analytics/queries';

export const runtime = 'nodejs';

export const GET = api.handler;
export const POST = api.handler;
export const OPTIONS = api.handler;
```

The catch-all route forwards any `/api/hypequery/*` request to hypequery.

## 4. Generate typed hooks for client components

`src/lib/hypequery-client.ts`

```typescript
import { createHooks } from '@hypequery/react';
import { InferApiType } from '@hypequery/serve';
import type { api } from '@/analytics/queries';

export const { useQuery: useMetric, useMutation: useMetricMutation } = createHooks<
  InferApiType<typeof api>
>({
  baseUrl: '/api/hypequery',
  api, // auto-extracts HTTP methods from route registration
});
```

## 5. Consume metrics in a Client Component

`app/dashboard/page.tsx`

```tsx
'use client';

import { useMetric } from '@/lib/hypequery-client';

export default function DashboardPage() {
  const { data: revenue, isLoading } = useMetric('weeklyRevenue', {
    startDate: '2024-01-01',
    endDate: '2024-01-31',
  });

  const { data: products } = useMetric('topProducts');

  if (isLoading || !revenue) return <p>Loading…</p>;

  return (
    <section>
      <h1>Revenue</h1>
      <pre>{JSON.stringify(revenue, null, 2)}</pre>
      <h2>Top products</h2>
      <ul>{products?.map((p) => <li key={p.name}>{p.name}: {p.revenue}</li>)}</ul>
    </section>
  );
}
```

## 6. Run locally

```bash
# Start Next.js
npm run dev

# Optional: run hypequery CLI for docs/openapi in parallel
npx hypequery dev src/analytics/queries.ts
# → http://localhost:4000/docs
```

Deploy to Vercel as usual—the `[...hq]` route runs alongside the rest of your app.

## Next steps

- Add middleware (`api.useAuth`) for API keys or JWTs
- Enable tenant isolation with `tenant: { extract, column, mode: 'auto-inject' }`
- Generate typed SDKs for other consumers (`extractClientConfig + createHooks`)
